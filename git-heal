#!/bin/bash
# git-heal: Automatically recover from git repository corruption
# Usage: git-heal [repo-path]
# If no path is provided, uses the current directory

set -euo pipefail

# ─── Colours ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ─── Helpers ───────────────────────────────────────────────────────────────────
info()    { echo -e "${BLUE}[INFO]${NC}  $1"; }
success() { echo -e "${GREEN}[OK]${NC}    $1"; }
warn()    { echo -e "${YELLOW}[WARN]${NC}  $1"; }
error()   { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# ─── Arguments ─────────────────────────────────────────────────────────────────
REPO_PATH="${1:-.}"
cd "$REPO_PATH" || error "Cannot access directory: $REPO_PATH"

# ─── Verify this is a git repo ─────────────────────────────────────────────────
if [ ! -d ".git" ]; then
    error "No .git directory found in $(pwd). Are you in a git repository?"
fi

echo ""
echo -e "${BLUE}╔══════════════════════════════════════╗${NC}"
echo -e "${BLUE}║          git-heal v1.0               ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════╝${NC}"
echo ""

# ─── Get repo info ─────────────────────────────────────────────────────────────
REPO_DIR=$(pwd)
REPO_NAME=$(basename "$REPO_DIR")
PARENT_DIR=$(dirname "$REPO_DIR")
BACKUP_DIR="${PARENT_DIR}/${REPO_NAME}-backup-$(date +%Y%m%d-%H%M%S)"
REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")

info "Repository: $REPO_DIR"
info "Remote:     ${REMOTE_URL:-none detected}"
info "Branch:     $BRANCH"
info "Backup:     $BACKUP_DIR"
echo ""

# ─── Check for corruption ──────────────────────────────────────────────────────
info "Running git fsck to assess corruption..."
if git fsck --quiet 2>/dev/null; then
    success "No corruption detected. Repository is healthy."
    exit 0
fi

warn "Corruption detected. Starting recovery process..."
echo ""

# ─── Confirm with user ─────────────────────────────────────────────────────────
echo -e "${YELLOW}This script will:${NC}"
echo "  1. Back up your current repository to $BACKUP_DIR"
echo "  2. Create a fresh git repository"
echo "  3. Copy all your files across"
echo "  4. Reconnect to the remote (if one exists)"
echo "  5. Force push to recover the remote"
echo ""
read -rp "Continue? (yes/no): " CONFIRM
if [ "$CONFIRM" != "yes" ]; then
    info "Aborted. No changes made."
    exit 0
fi
echo ""

# ─── Step 1: Backup ────────────────────────────────────────────────────────────
info "Step 1/5 — Backing up repository..."
cp -r "$REPO_DIR" "$BACKUP_DIR"
success "Backup created at $BACKUP_DIR"

# ─── Step 2: Wipe and reinitialise ─────────────────────────────────────────────
info "Step 2/5 — Removing corrupted .git directory..."
rm -rf .git
git init
git branch -M "$BRANCH"
success "Fresh git repository initialised on branch $BRANCH"

# ─── Step 3: Files already in place ───────────────────────────────────────────
info "Step 3/5 — Working directory preserved"
success "Working directory intact"

# ─── Step 4: Stage and commit ──────────────────────────────────────────────────
info "Step 4/5 — Staging and committing all files..."
git add .
FILE_COUNT=$(git diff --cached --name-only | wc -l)
info "Staging $FILE_COUNT files..."
git commit -m "recovery: restore repository after git corruption ($(date '+%Y-%m-%d %H:%M'))"
success "Committed $FILE_COUNT files"

# ─── Step 5: Reconnect remote and push ────────────────────────────────────────
if [ -n "$REMOTE_URL" ]; then
    info "Step 5/5 — Reconnecting to remote and force pushing..."
    git remote add origin "$REMOTE_URL"
    git push -u origin "$BRANCH" --force
    success "Force pushed to $REMOTE_URL"
else
    warn "Step 5/5 — No remote detected. Skipping push."
    warn "To add a remote manually: git remote add origin <url>"
fi

# ─── Done ──────────────────────────────────────────────────────────────────────
echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Recovery complete!                              ║${NC}"
echo -e "${GREEN}║                                                  ║${NC}"
echo -e "${GREEN}║  Backup preserved at:                            ║${NC}"
echo -e "${GREEN}║  $BACKUP_DIR${NC}"
echo -e "${GREEN}║                                                  ║${NC}"
echo -e "${GREEN}║  Delete backup after verifying GitHub is correct ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════╝${NC}"
echo ""